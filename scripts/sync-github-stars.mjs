import { readdirSync, readFileSync, writeFileSync, existsSync } from 'node:fs';
import { resolve, basename } from 'node:path';
import yaml from 'js-yaml';

const catalogDir = resolve('catalog');
const outputFile = resolve(catalogDir, 'metadata', 'github-stars.yaml');

function collectYamlFiles(dir) {
  const results = [];
  for (const entry of readdirSync(dir, { withFileTypes: true })) {
    const fullPath = resolve(dir, entry.name);
    if (entry.isDirectory()) {
      results.push(...collectYamlFiles(fullPath));
    } else if (entry.name.endsWith('.yaml')) {
      results.push(fullPath);
    }
  }
  return results;
}

function extractGitHubRepos() {
  const repos = [];

  for (const subdir of ['apps', 'fonts']) {
    const dir = resolve(catalogDir, subdir);
    if (!existsSync(dir)) continue;

    for (const file of collectYamlFiles(dir)) {
      const id = basename(file, '.yaml');
      const content = yaml.load(readFileSync(file, 'utf8'));
      const github = content?.links?.github;

      if (github) {
        const match = github.match(/github\.com\/([^/]+\/[^/]+)/);
        if (match) {
          repos.push({ type: subdir.replace(/s$/, ''), id, repo: match[1] });
        }
      }
    }
  }

  return repos;
}

async function fetchStars(repo) {
  const url = `https://api.github.com/repos/${repo}`;
  const headers = { 'Accept': 'application/vnd.github.v3+json', 'User-Agent': 'perch-gallery' };

  if (process.env.GITHUB_TOKEN) {
    headers['Authorization'] = `token ${process.env.GITHUB_TOKEN}`;
  }

  const response = await fetch(url, { headers });

  if (!response.ok) {
    if (response.status === 403) {
      console.warn(`  Rate limited, stopping.`);
      return null;
    }
    console.warn(`  Failed to fetch ${repo}: ${response.status}`);
    return undefined;
  }

  const data = await response.json();
  return data.stargazers_count;
}

async function main() {
  const repos = extractGitHubRepos();
  console.log(`Found ${repos.length} entries with GitHub links.\n`);

  // Load existing data to preserve entries we can't fetch
  let existing = {};
  if (existsSync(outputFile)) {
    existing = yaml.load(readFileSync(outputFile, 'utf8')) || {};
  }

  const stars = { ...existing };
  let fetched = 0;
  let rateLimited = false;

  for (const { type, id, repo } of repos) {
    const key = `${type}/${id}`;
    process.stdout.write(`  ${key} (${repo})...`);

    const count = await fetchStars(repo);

    if (count === null) {
      rateLimited = true;
      console.log(' rate limited');
      break;
    }

    if (count !== undefined) {
      stars[key] = { repo, stars: count };
      console.log(` ${count.toLocaleString()}`);
      fetched++;
    } else {
      console.log(' failed');
    }

    // Brief pause to avoid rate limiting
    await new Promise(r => setTimeout(r, 100));
  }

  const header = '# GitHub star counts for catalog entries.\n# Auto-generated by: node scripts/sync-github-stars.mjs\n# Last updated: ' + new Date().toISOString().slice(0, 10) + '\n\n';
  const output = header + yaml.dump(stars, { lineWidth: 120, sortKeys: true });
  writeFileSync(outputFile, output, 'utf8');

  console.log(`\nSynced ${fetched} repos.`);
  if (rateLimited) {
    console.log('Set GITHUB_TOKEN env var to increase rate limit (5000/hr vs 60/hr).');
  }
}

main().catch(err => {
  console.error(err);
  process.exit(1);
});
